<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Underpass: Building Packages  in a Chroot</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Underpass
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Building Packages in a Chroot </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>To distribute binary packages for a variety of potforms of varying versions, it's common to use a <em>chroot</em> to build in. This is to make sure that a the package binary is linked against the right libraries, which is required so the user doesn't have to build anything from source. Unlike docker or Virtualbox, a chroot uses the base running kernel on host machine, but provides a different set of runtime libraries and tools.</p>
<h1><a class="anchor" id="autotoc_md9"></a>
Creating a Chroot</h1>
<p>All platforms that use the *.deb* packaging format, like Debian and Ubuntu, can use the <em>debbootstrap</em> program to create the chroot. Debootstrap lets you pick the architect to support, <em>&ndash;arch amd64</em> builds files for the X86_64 platform. after that the version of the distribution is specified, followed by the directory to install the files in, and finally the URL to download packages from. Once done, change to the installation directory, and type <em>sudo chroot .</em>. You'll now be in a minimal runtime environment. The first thing I do is create a */etc/debian_chroot* file containing the name of the distribution. This puts the this value into the command prompt for the shell, which is very useful when you have multiple chroots.</p>
<p>As the <em>chroot</em> program requires one to be root, a utility program called <em>schroot</em> can be used to fake root. Once the initial chroot is created, change to the directory containing the downloaded files, and type these shell commands. Some of the programs used to build packages need these, which aren't present in the chroot, as they have to be shared from the host platform.</p>
<ul>
<li>mount -t proc proc /proc</li>
<li>mount &ndash;rbind /sys sys/</li>
<li>mount &ndash;rbind /dev dev/</li>
</ul>
<p>Once that initial setup is done, it's time to download more packages. The default config file for a chroot is limited to just the main repository. Not all of the packages Underpass depends on are in main, so add <em>universe</em> to get the rest, and then <em>apt-get update</em>. Your /etc/apt/sources.list file should now look like this:</p>
<p>deb <a href="http://archive.ubuntu.com/ubuntu">http://archive.ubuntu.com/ubuntu</a> focal main universe</p>
<p>Finally edit *~/.bashrc* and add these three lines at the bottom. One specifies the path to a file pkg-config needs, but isn't always distributed, so it's included. The other is for <em>locale</em>, so it stops clutterin the terminal with warnings.</p>
<ul>
<li>export PKG_CONFIG_PATH=/home/rob/underpass/m4</li>
<li>export LANG=C</li>
<li>export GPG_TTY="$(tty)"</li>
</ul>
<p>To create signed packages, you need a <em>GPG</em> key pair setup, so mjight as well do that now. Type <em>gpg &ndash;full-generate-key</em>, and answer the questions. This will only work if you've execute the mount commands as documented above.</p>
<h2><a class="anchor" id="autotoc_md10"></a>
For Debian</h2>
<p>sudo /usr/sbin/debootstrap &ndash;arch amd64 bullseye bullseye/ <a href="http://deb.debian.org/debian/">http://deb.debian.org/debian/</a></p>
<p>Start by installing packages needed to build Underpass.</p>
<p>apt install gcc g++ pkg-config libboost-all-dev libgdal-dev git libxml++2.6-dev git libosmium2-dev libpq-dev ccache libgumbo-dev libssl-dev make debhelper debconf libpq5-dev chrpath devscripts gpg git</p>
<h2><a class="anchor" id="autotoc_md11"></a>
Ubuntu Focal (20.04 LTS)</h2>
<p>sudo /usr/sbin/debootstrap &ndash;arch amd64 groovy groovy/ <a href="http://archive.ubuntu.com/ubuntu/">http://archive.ubuntu.com/ubuntu/</a></p>
<p>Start by installing packages needed to build Underpass.</p>
<p>apt install gcc g++ pkg-config git libxml++2.6-dev libpq-dev ccache libssl-dev make debhelper debconf libboost1.71-dev doxygen libgdal-dev libgumbo-dev libbz2-dev openmpi-bin libboost-system1.71-dev libboost-serialization1.71-dev libboost-filesystem1.71-dev libboost-regex1.71-dev libboost-log1.71-dev libboost-program-options1.71-dev libboost-iostreams1.71-dev libosmium2-dev librange-v3-dev libboost-locale1.71-dev libtool-bin libzip-dev gpg ccache git libpq-dev make debhelper devscripts python3-all doxygen pkg-config librange-v3-dev libpq-dev libgdal-dev libssl-dev libtool-bin libltdl-dev libgumbo-dev</p>
<h1><a class="anchor" id="autotoc_md12"></a>
Building Libpqxx Packages</h1>
<p>The version of <em>libpqxx (6.x)</em> that's included in current (Aug 2021) distribution like <em>Debian Bullseye</em> or <em>Unbuntu Hirsute (21.04)</em> has a bug triggered by <em>libxml++</em>. Since Underpass uses libxml++ and libpqxx, we have to build a package of a newer version (7.x). I added Debian packaging files to a git repository to make this easier, Get that fork here:</p>
<p>git clone <a href="https://github.com/robsavoye/libpqxx.git">https://github.com/robsavoye/libpqxx.git</a></p>
<p>Once I do that, I run <em>git tag</em>, and the checkout the latest official release branch. There's a configure bug in the libpqxx sources I haven't gotten around to fixing yet, so I edit <em>configure.ac</em>, and comment out this one line like so:</p>
<p>dnl AX_CXX_COMPILE_STDCXX_17([noext])</p>
<p>Then run ./autogen.sh, which produces the scripts used for configuring. Now thast you have the <em>configure</em> script, configure libpqxx lioke this:</p>
<p>./configure CXX="ccache g++" CXXFLAGS="-std=c++17 -g -O2" &ndash;disable-dependency-tracking</p>
<p>After that, change to the <em>debian</em> directory, and type <em>make deb -i -k</em>. That'll build the deb packages, and at the end, have you GPG sign them. Once built, install the two packages, and you're all set to go build Underpass.</p>
<h1><a class="anchor" id="autotoc_md13"></a>
Building Underpass Packages</h1>
<p>The Underpass git repository is at:</p>
<p><a href="https://github.com/hotosm/underpass.git">https://github.com/hotosm/underpass.git</a></p>
<p>Once downloaded, change to the source directory and run *./autogen.sh*. Once the configure files have been built, configure Underpass like this:</p>
<p>./configure CXX="ccache g++" CXXFLAGS="-std=c++17 -g -O2" &ndash;disable-dependency-tracking</p>
<p>and then typing <em>make deb</em> builds the packages, and has you sign them. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
