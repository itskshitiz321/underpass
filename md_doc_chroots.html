<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Underpass: Building Packages  in a Chroot</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Underpass
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Building Packages in a Chroot </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >To distribute binary packages for a variety of potforms of varying versions, it's common to use a <em>chroot</em> to build in. This is to make sure that a the package binary is linked against the right libraries, which is required so the user doesn't have to build anything from source. Unlike docker or Virtualbox, a chroot uses the base running kernel on host machine, but provides a different set of runtime libraries and tools.</p>
<h1><a class="anchor" id="autotoc_md7"></a>
Creating a Chroot</h1>
<p >All platforms that use the *.deb* packaging format, like Debian and Ubuntu, can use the <em>debbootstrap</em> program to create the chroot. Debootstrap lets you pick the architect to support, <code>--arch amd64</code> builds files for the X86_64 platform. after that the version of the distribution is specified, followed by the directory to install the files in, and finally the URL to download packages from. Once done, change to the installation directory, and type <code>sudo chroot .</code>. You'll now be in a minimal runtime environment. The first thing I do is create a <code>/etc/debian_chroot</code> file containing the name of the distribution. This puts the this value into the command prompt for the shell, which is very useful when you have multiple chroots.</p>
<p >As the <em>chroot</em> program requires one to be root, a utility program called <em>schroot</em> can be used to fake root. Once the initial chroot is created, change to the directory containing the downloaded files, and type these shell commands. Some of the programs used to build packages need these, which aren't present in the chroot, as they have to be shared from the host platform.</p>
<div class="fragment"><div class="line">mount -t proc proc /proc</div>
<div class="line">mount --rbind /sys sys/</div>
<div class="line">mount --rbind /dev dev/</div>
</div><!-- fragment --><p >Once that initial setup is done, it's time to download more packages. The default config file for a chroot is limited to just the main repository. Not all of the packages Underpass depends on are in main, so add <em>universe</em> to get the rest, and then <code>apt-get update</code>. Your <code>/etc/apt/sources.list</code> file should now look like this:</p>
<div class="fragment"><div class="line">deb http://archive.ubuntu.com/ubuntu focal main universe</div>
</div><!-- fragment --><p >Finally edit <code>~/.bashrc</code> and add these three lines at the bottom. One specifies the path to a file pkg-config needs, but isn't always distributed, so it's included. The other is for <em>locale</em>, so it stops clutterin the terminal with warnings.</p>
<div class="fragment"><div class="line">export PKG_CONFIG_PATH=/home/rob/underpass/m4</div>
<div class="line">export LANG=C</div>
<div class="line">export GPG_TTY=&quot;$(tty)&quot;</div>
</div><!-- fragment --><p >To create signed packages, you need a <em>GPG</em> key pair setup, so might as well do that now. Type <code>gpg --full-generate-key</code>, and answer the questions. This will only work if you've execute the mount commands as documented above.</p>
<h2><a class="anchor" id="autotoc_md8"></a>
For Debian</h2>
<div class="fragment"><div class="line">sudo /usr/sbin/debootstrap --arch amd64 bullseye bullseye/ http://deb.debian.org/debian/</div>
</div><!-- fragment --><p >Start by installing packages needed to build Underpass.</p>
<div class="fragment"><div class="line">sudo apt-get -y install \</div>
<div class="line">    git gcc g++ pkg-config make debhelper debconf chrpath ccache devscripts gpg \</div>
<div class="line">    libgdal-dev libosmium2-dev libpq-dev libgumbo-dev \</div>
<div class="line">    libssl-dev libpq5-dev libxml++2.6-dev libboost-all-dev</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md9"></a>
Ubuntu Focal (20.04 LTS)</h2>
<div class="fragment"><div class="line">sudo /usr/sbin/debootstrap --arch amd64 focal focal/ http://archive.ubuntu.com/ubuntu/</div>
</div><!-- fragment --><p >Start by installing packages needed to build Underpass.</p>
<div class="fragment"><div class="line">sudo apt-get -y install \</div>
<div class="line">    git make gcc g++ pkg-config gpg debhelper debconf devscripts python3-all \</div>
<div class="line">    libgdal-dev libpq-dev libgumbo-dev openmpi-bin \</div>
<div class="line">    libxml++2.6-dev ccache libssl-dev libzip-dev libbz2-dev \</div>
<div class="line">    libboost-all-dev libosmium2-dev osmium-tool \</div>
<div class="line">    doxygen librange-v3-dev libtool-bin libltdl-dev  </div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md10"></a>
Ubuntu Groovy (20.10)</h2>
<div class="fragment"><div class="line">sudo /usr/sbin/debootstrap --arch amd64 groovy groovy/ http://archive.ubuntu.com/ubuntu/</div>
</div><!-- fragment --><p >Install dependencies as above. Note that the version of boost is 1.74</p>
<h2><a class="anchor" id="autotoc_md11"></a>
Ubuntu Hirsute (21.04)</h2>
<div class="fragment"><div class="line">sudo /usr/sbin/debootstrap --arch amd64 hirsute hirsute/ http://archive.ubuntu.com/ubuntu/</div>
</div><!-- fragment --><p >Install dependencies as above. Note that the version of boost is 1.74</p>
<h1><a class="anchor" id="autotoc_md12"></a>
Building Libpqxx Packages</h1>
<p >The version of <em>libpqxx (6.x)</em> that's included in current (Aug 2021) distribution like <em>Debian Bullseye</em> or <em>Unbuntu Hirsute (21.04)</em> has a bug triggered by <em>libxml++</em>. Since Underpass uses libxml++ and libpqxx, we have to build a package of a newer version (7.x). I added Debian packaging files to a git repository to make this easier, Get that fork here:</p>
<div class="fragment"><div class="line">git clone https://github.com/robsavoye/libpqxx.git</div>
</div><!-- fragment --><p >Once I do that, I run <code>git tag</code>, and the checkout the latest official release branch. There's a configure bug in the libpqxx sources I haven't gotten around to fixing yet, so I edit <code>configure.ac</code>, and comment out this one line like so:</p>
<div class="fragment"><div class="line">dnl AX_CXX_COMPILE_STDCXX_17([noext])</div>
</div><!-- fragment --><p >Then run <code>./autogen.sh</code>, which produces the scripts used for configuring. Now that you have the <code>configure</code> script, configure libpqxx like this:</p>
<div class="fragment"><div class="line">./configure CXX=&quot;ccache g++&quot; CXXFLAGS=&quot;-std=c++17 -g -O2&quot; --disable-dependency-tracking</div>
</div><!-- fragment --><p >After that, change to the <em>debian</em> directory, and type <code>make deb -i -k</code>. That'll build the deb packages, and at the end, have you GPG sign them. Once built, install the two packages, and you're all set to go build Underpass.</p>
<h1><a class="anchor" id="autotoc_md13"></a>
Building Underpass Packages</h1>
<p >The Underpass git repository is at:</p>
<p ><a href="https://github.com/hotosm/underpass.git">https://github.com/hotosm/underpass.git</a></p>
<p >Once downloaded, change to the source directory and run <code>./autogen.sh</code>. Once the configure files have been built, configure Underpass like this:</p>
<div class="fragment"><div class="line">./configure CXX=&quot;ccache g++&quot; CXXFLAGS=&quot;-std=c++17 -g -O2&quot; --disable-dependency-tracking</div>
</div><!-- fragment --><p >and then typing <code>make deb -i -k</code> builds the packages, and has you sign them. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2
</small></address>
</body>
</html>
