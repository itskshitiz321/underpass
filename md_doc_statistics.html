<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Underpass: Statistics Calculations</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Underpass
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Statistics Calculations </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Underpass process two input streams for data, but only one is used for the initial statistics calculations. <a class="el" href="md_doc_changefile.html">ChangeSet</a> are used to populate some of the columns in the database, but aren't used during statistics calculations by the backend. Only the <a class="el" href="md_doc_changefile.html">OsmChange</a> file is used, as it contains the the data that is changed.</p>
<p>The OsmChange data file contains 3 categories of data, what was created, modified, or deleted. Currently only changed and modified data are used for statistics calculations.</p>
<p>All of the changed data is parsed into a <a href="https://hotosm.github.io/underpass/classosmchange_1_1OsmChange.html">data structure</a> that can be passed between classes. This data structure contains all the data as well as the associated action, create or modify. The parsed data is then passed to the <a href="https://hotosm.github.io/underpass/classosmchange_1_1OsmChangeFile.html#a4a6035b16ec815be6e0289b65bcbaaad">OsmChangeFile::collectStat()</a> method to do the calculations. While currently part of the core code, in the future this will be a plugin, allowing others to create different statistics calculations without modifying the code.</p>
<h1><a class="anchor" id="autotoc_md46"></a>
What Is Collected</h1>
<p>The original statistics counted buildings, waterways, and POIs. The new statistics break this down into two categories, accumulates statistics for things like <em>buildings</em>, as well as the more detailed representation, like what type of building it is. The list of values for buildings is configurable. Currently it's a simple list, but in the future will be populated by a config file in <a href="https://yaml.org/">YAML</a> format.</p>
<p>OpenStreetMap features support a <em>keyword</em> and <em>value</em> pair. The keywords are <a href="https://taginfo.openstreetmap.org/">loosely defined</a>, and over time some have changed and been improved. Often new mappers get confused, so may use keywords and values in an inconsistent manner. Also over time the definitions of some tags has changed, or been extended.</p>
<p>For example, let's look at schools. There is a variety of ways school buildings are tagged. Sometimes it's <em>building=school</em>, with school as the value. Sometimes school is the keyword, and the value is the type of school. In this case, the type of school is accumulated, as well as a generic <em>school</em> count. Also if <em>building=school</em> isn't used, then every school also increments the count of buildings.</p>
<p>Each category of data has the total accumulated value, as well as the more detailed breakdown. For example, it's possible to extract statistics for only hospitals, which is a subset of all the buildings. As keywords and values can be in different feature categories, some are checked for in multiple ways. Some keywords and values may be spelled differently than the default, so variations are also looked for to be complete.</p>
<p>To find all the common tags, several continents worth of data was analyzed to find the most common patterns for the features we want to collect statistics for. Mixed with inconsistent tagging schemes is random capitalization, misspellings, and international spellings. The attempt is made to catch all reasonable variations. <a href="https://taginfo.openstreetmap.org/">TagInfo</a> was used to find totals of some variations, with weird tagging that was not very common gets ignored to avoid performance impacts, and data bloat.</p>
<h2><a class="anchor" id="autotoc_md47"></a>
Building Types</h2>
<p>Most buildings added by remote tracing of satellite imagery lack any metadata tags beyond <em>building=yes</em>. When local mappers import more detailed data, or update the existing metadata, those values get added. This is the current set of building values being accumulated.</p>
<ul>
<li>hospital</li>
<li>school</li>
<li>healthcare</li>
<li>clinic</li>
<li>health center</li>
<li>health centre</li>
<li>latrine</li>
<li>latrines</li>
<li>toilet</li>
<li>toilets</li>
</ul>
<h2><a class="anchor" id="autotoc_md48"></a>
Amenity Types</h2>
<p>Most amenities are added by local mappers or through a data import. Not all amenities are buildings, but for our use case that's all that is analyzed. These are the common values for the <em>amenity</em> keyword.</p>
<ul>
<li>hospital</li>
<li>school</li>
<li>clinic</li>
<li>kindergarten</li>
<li>drinking_water</li>
<li>health_facility</li>
<li>health_center</li>
<li>healthcare</li>
</ul>
<h2><a class="anchor" id="autotoc_md49"></a>
Places Types</h2>
<p>Places contain multiple features, and are mostly used to determine local metadata improvements.</p>
<ul>
<li>village</li>
<li>hamlet</li>
<li>neighborhood</li>
<li>city</li>
<li>town</li>
</ul>
<h2><a class="anchor" id="autotoc_md50"></a>
Highway Types</h2>
<p>Highways traced from satellite imagery often lack metadata beyond the functional type. For example, a highway that connects two villages is easy to determine. An accumulated value for the total of highways, and the total length in kilometers is store as an aggregate. More detailed statistics are also kept allowing more detail when needed.</p>
<ul>
<li>highway</li>
<li>tertiary</li>
<li>secondary</li>
<li>unclassified</li>
<li>track</li>
<li>residential</li>
<li>path</li>
<li>bridge</li>
<li>waterway</li>
</ul>
<h2><a class="anchor" id="autotoc_md51"></a>
School Types</h2>
<p>Wen <em>school</em> is a keyword, there are several values for the type of school. An aggregate total of schools is calculated, as well as detail for the type of school.</p>
<ul>
<li>primary</li>
<li>secondary</li>
<li>kindergarten</li>
</ul>
<h1><a class="anchor" id="autotoc_md52"></a>
Calculation Data flow</h1>
<p>The data is processed by <a href="https://github.com/hotosm/underpass">Underpass</a>. Underpass downloads the changeset and the OsmChange files from the OpenStreetMap planet server every minute. Downloaded files are also cached on disk, so it's also possible to process data without a network connection. Once the data is parsed from the respective data formats, it gets passed to the <a href="https://hotosm.github.io/underpass/classosmchange_1_1OsmChangeFile.html#a4a6035b16ec815be6e0289b65bcbaaad">OsmChangeFile::collectStat()</a> method. That method loops through the data structure containing the changes to the map data. Within that method, it calls <a href="https://hotosm.github.io/underpass/classosmchange_1_1OsmChangeFile.html">ChangeSetFile::scanTags()</a>, which does all the real work. The <em>scanTags()</em> method uses the above lists of keywords and values. ScanTags() returns an array of statistics for the desired features. That array is then converted by collectStats() into the <a href="https://hotosm.github.io/underpass/classosmchange_1_1ChangeStats.html">statistics data structure</a>, and control returns to the processing thread.</p>
<p>The processing thread then passes the statistics data to <a href="https://hotosm.github.io/underpass/classosmstats_1_1QueryOSMStats.html#aa0aeffb3bb77e4891553ca1883f11a10">osmstats::applyChange()</a>, to insert it into the database. <em>ApplyChange()</em> checks the statistics data for it's location, and currently if it's not in a priority country, it's not added to the database.</p>
<h1><a class="anchor" id="autotoc_md53"></a>
Statistics Database</h1>
<p>The new statistics database schema is very different from the current one used for <a class="el" href="md_doc_osmstats.html">OSM Stats</a>. The current database schema is more oriented towards supporting the display functions, and is not extendable beyond the few features it collects data about.</p>
<p>The new schema is designed to be more flexible to track more types of features, as well as to be more flexible on the types of queries it can support. By adding spatial data, it can filter data extracts by polygon. The current implementation is limited to using country boundaries.</p>
<h2><a class="anchor" id="autotoc_md54"></a>
geoboundaries table</h2>
<p>This a static table, the data is maintained outside of this project. It can be produced by extracting administrative boundaries from OpenStreetMap data to update if changes are made to the boundaries. This table is not used by backend, it's primarily to assist the frontend to create a list of existing polygons that can be used by the frontend to filter data. Rather than the existing raw_countries table in the osmstats schema which was English only, this one support internationalized names, and both the official 2 and 3 letter ISO abbreviations.</p>
<p>Currently this table contains the data for most countries, and US states. Other boundaries could also be added, and using admin_level to differentiate them from the existing ones. For example, this could also be populated by Tasking Manager project boundaries.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Keyword   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">cid   </td><td class="markdownTableBodyNone">An internal ID for this administrative boundary    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">name   </td><td class="markdownTableBodyNone">The name of the boundary    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">admin_level   </td><td class="markdownTableBodyNone">The administrative level of this boundary    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">tags   </td><td class="markdownTableBodyNone">Other metadata related to this boundary    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">priority   </td><td class="markdownTableBodyNone">If this is in a priority boundary    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">boundary   </td><td class="markdownTableBodyNone">The multipolygon of this boundary   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md55"></a>
changesets table</h2>
<p>This is the primary table used to contain the data for each changeset. All of the data is stored in a table for better query performance on large data sets. It also limits needing SQL <a href="https://www.postgresql.org/docs/13/functions-subquery.html">sub queries</a> or a <a href="https://www.postgresql.org/docs/13/tutorial-join.html">JOIN</a> between tables, reducing complexity.</p>
<p>An <a href="https://www.postgresql.org/docs/13/hstore.html">hstore</a> is used to store the statistics instead of having a separate table for each feature to allow for more flexibility. An hstore is a key &amp; value pair, and multiple data items can be stored in a single column, indexed by the key. This allows for more features to be added by the backend and the frontend, without having modify the database schema.</p>
<p>An example query to count the total number of buildings added by the user <b>4321</b> for a Tasking Manager project <b>1234</b> would be this: </p><blockquote class="doxtable">
<p>SELECT SUM(CAST(added::hstore-&gt;'building' AS DOUBLE precision)) FROM </p>
</blockquote>
<p>changesets WHERE 'hotosm-project1234' = ANY(hashtags) AND user_id=4321;</p>
<p>The source is the satellite imagery used for remote mapping.</p>
<p>&#160;</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Keyword   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">id   </td><td class="markdownTableBodyNone">The ID of this changeset    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">editor   </td><td class="markdownTableBodyNone">The editor used for this changeset    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">user_id   </td><td class="markdownTableBodyNone">The OSM User ID of the mapper    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">created_at   </td><td class="markdownTableBodyNone">The timestamp when this changes was uploaded    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">closed_at   </td><td class="markdownTableBodyNone">The timestamp when this uploaded change completed processing    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">updated_at   </td><td class="markdownTableBodyNone">The timestamp when this last had data updated    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">added   </td><td class="markdownTableBodyNone">An hstore array of the added map features    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">modified   </td><td class="markdownTableBodyNone">An hstore array of the modified map features    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">deleted   </td><td class="markdownTableBodyNone">An hstore array of the deleted map features    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">hashtags   </td><td class="markdownTableBodyNone">An array of the hashtags used for this changeset    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">source   </td><td class="markdownTableBodyNone">The imagery source used for this changeset    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">validated   </td><td class="markdownTableBodyNone">Where this changeset has been validated in the Tasking Manager    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">bbox   </td><td class="markdownTableBodyNone">The bounding box of this changeset   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md56"></a>
users table</h2>
<p>This table contains data on mappers, and is used to track indivigual activity. Often badges are given based on this data. Most of this data comes from the Tasking Manager, but is copied hear to improve performance.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Keyword   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">id   </td><td class="markdownTableBodyNone">The OSM ID of this mapper    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">name   </td><td class="markdownTableBodyNone">The OSM user name of the mapper    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">tm_registration   </td><td class="markdownTableBodyNone">The timestamp of when the mapper registered with the tasking manager    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">osm_registration   </td><td class="markdownTableBodyNone">The timestamp of when the mapper registered with openstreetmap    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">tasks_mapped   </td><td class="markdownTableBodyNone">The number of tasking manager tasks completed    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">tasks_validated   </td><td class="markdownTableBodyNone">The number of tasking manager tasks validated    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">projects_mapped   </td><td class="markdownTableBodyNone">The number of tasking manager tasks invalidated    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">gender   </td><td class="markdownTableBodyNone">The mappers gender, when available    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">home   </td><td class="markdownTableBodyNone">The mappers home location, when available   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md57"></a>
ground data table</h2>
<p>This table collects statistics on ground mapping campaigns, which contains different metadata that gets lost when the data is edited for uploading to OpenStreetMap. This table is currently a placeholder for future developement at this time, so unused for now,</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Keyword   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">starttime   </td><td class="markdownTableBodyNone">The timestamp of when the user opened the app and started data collection    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">endtime   </td><td class="markdownTableBodyNone">The timestamp for when the data collection was completed    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">username   </td><td class="markdownTableBodyNone">The username of the mapper, not the same as an OSM username    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">changeset_id   </td><td class="markdownTableBodyNone">Changeset ID applied when the data is uploaded to OSM    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">location   </td><td class="markdownTableBodyNone">The coordinates of this POI   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md58"></a>
training data table</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Keyword   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">name   </td><td class="markdownTableBodyNone">The mappers name    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">local   </td><td class="markdownTableBodyNone">Whether it was a local training, or remote    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">organization   </td><td class="markdownTableBodyNone">The organization doing the training    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">tools   </td><td class="markdownTableBodyNone">The software tools covered in the training    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">teams   </td><td class="markdownTableBodyNone">The teams the mapper is a member of    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">gender   </td><td class="markdownTableBodyNone">The self-defined gender (optional) of the mapper    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">hours   </td><td class="markdownTableBodyNone">The hours of training    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">age   </td><td class="markdownTableBodyNone">The age (optional) of the mapper   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md59"></a>
validation data table</h2>
<p>Keyword | Description -----&mdash;|---------&mdash; </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
