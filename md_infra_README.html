<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Underpass: Underpass - Infrastructure Stack</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Underpass
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Underpass - Infrastructure Stack </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >This directory / repository contains code that spins up the infrastructure necessary to run Underpass.</p>
<p ><img src="/images/underpass.png" alt="Underpass architecture diagram" class="inline"/></p>
<p >The stack consists of</p>
<ul>
<li>A PostgreSQL RDS database with 1TB of disk space</li>
<li>An S3 bucket to store backups of the database</li>
<li>An instance that runs the C++ binaries that process data</li>
<li>An instance that runs the Python API service</li>
<li>CloudWatch logging and metrics collection</li>
<li>CloudWatch alerts</li>
<li>CloudFront CDN distribution that reads from the API service</li>
<li>Route53 DNS entries (A or ALIAS) pointing to the CloudFront distribution</li>
</ul>
<h1><a class="anchor" id="autotoc_md72"></a>
A (very) brief, basic introduction to Terraform</h1>
<p >We use terraform to spawn our infrastructure. We can use JSON or the Hashicorp declarative DSL called Hashicorp Configuration Language (HCL) to declare the state of the infrastructure that we can then use to deploy the infrastructure, track changes to the infrastructure, apply the diff non-destructively if we make changes and even destroy the infrastructure.</p>
<p >The state of the current deployed infrastructure is stored in statefiles with extension <code>.tfstate</code>. These are the sources of truths and must not be meddled with. In order to collaboratively work with statefiles, we can use a shared backend to store the statefile to which other collaborators would have access.</p>
<p >In our case, we use the terraform cloud that has all the bells and whistles needed to maintain our infrastructure state files.</p>
<p >We use the following version of terraform to run our code</p>
<div class="fragment"><div class="line">~/underpass $ terraform -v</div>
<div class="line">Terraform v1.0.0</div>
<div class="line">on linux_amd64</div>
<div class="line">+ provider registry.terraform.io/hashicorp/aws v3.42.0</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md73"></a>
Deploying the infrastructure</h1>
<ul>
<li>Get session token</li>
</ul>
<p >This is a temporary token that can be used to deploy resources on-to AWS. It expires in one hour by default.</p>
<div class="fragment"><div class="line">~/underpass Â» aws sts get-session-token --output json</div>
<div class="line">{</div>
<div class="line">    &quot;Credentials&quot;: {</div>
<div class="line">        &quot;AccessKeyId&quot;: &quot;ASIAZYDVV4ILEMQV3H57&quot;,</div>
<div class="line">        &quot;SecretAccessKey&quot;: &quot;62Xm7KKhpljQJEC0yppSZz0fDW3SYc/QMT99J89l&quot;,</div>
<div class="line">        &quot;SessionToken&quot;: &quot;FwoGZXIvYXdzE...sbQFWqz89I11mafgWQ5gBue6o=&quot;,</div>
<div class="line">        &quot;Expiration&quot;: &quot;2021-06-02T21:37:19Z&quot;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><ul>
<li>Assume role</li>
</ul>
<p >Session tokens can't be used to invoke IAM API. We need more privileges for it. We use STS assume-role to gain more privileged - but still temporary - access to AWS API.</p>
<div class="fragment"><div class="line">aws sts assume-role --serial-number arn:aws:iam::&lt;ACCOUNT_ID&gt;:mfa/&lt;username&gt; --token-code 729586 --role-arn arn:aws:iam::670261699094:role/&lt;username&gt;-terraform-assumeRole --role-session-name terraform1 --output json</div>
<div class="line">{</div>
<div class="line">    &quot;Credentials&quot;: {</div>
<div class="line">        &quot;AccessKeyId&quot;: &quot;ASIAZYDVV4ILI4C4EWHX&quot;,</div>
<div class="line">        &quot;SecretAccessKey&quot;: &quot;S2UK+XuLq2ZZo1jlEhu+QU9tQVGdrvwTQ/fciu59&quot;,</div>
<div class="line">        &quot;SessionToken&quot;: &quot;FwoGZXIvYXdzEND//////////wEaDPSm5TBmApFmXm2qHyKuASPdPvoP74pkzF+ebQaaPRC1y0xQfx2eOGNgVZkx0MHaOc23a0SE7tX6+FnmrNFf0LN1dm3qiPjxGV1cfGGsipURtfY4KRxpEBhtdamqCr35YZ1X5f0Ftr8xzHdFGNDw0YR9pywHaFCvtS355bFPcV2BMl5Cdt3NztHntx2okd0Jo9ljxmfj3Mz05nXOvNah061JlM2K35m6actdc6EaTjiaYbKMNSnxJcOG8mCCOSj8/P2FBjIt5EeuLM/3pZzVn2co6iqnZla8voQBTRm01DKhY85EusbjJA3HzwyX8oRJfQda&quot;,</div>
<div class="line">        &quot;Expiration&quot;: &quot;2021-06-08T15:28:12Z&quot;</div>
<div class="line">    },</div>
<div class="line">    &quot;AssumedRoleUser&quot;: {</div>
<div class="line">        &quot;AssumedRoleId&quot;: &quot;AROAZYDVV4ILBBV7CR2B5:terraform1&quot;,</div>
<div class="line">        &quot;Arn&quot;: &quot;arn:aws:sts::670261699094:assumed-role/&lt;username&gt;-terraform-assumeRole/terraform1&quot;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p >Set these as <code>AWS_ACCESS_KEY_ID</code>, <code>AWS_SECRET_ACCESS_KEY</code>, and <code>AWS_SESSION_TOKEN</code> respectively in the Environment Variables section for Terraform cloud</p>
<ul>
<li>Initialize the modules</li>
</ul>
<p >Run <code>terraform init</code> to download the modules and providers we use for our code</p>
<ul>
<li>Plan the infrastructure</li>
</ul>
<p >Manually run <code>terraform plan</code> on your workstation or setup automatic infrastructure planning on Terraform cloud triggered by pushes to the GitHub repository.</p>
<ul>
<li>Apply the plan</li>
</ul>
<p >If you are satisfied with the infrastructure plan and all looks good, then apply the infrastructure by running <code>terraform apply</code></p>
<h1><a class="anchor" id="autotoc_md74"></a>
LICENSE</h1>
<p >TO BE DECIDED</p>
<h2><a class="anchor" id="autotoc_md75"></a>
Contribution guidelines</h2>
<ul>
<li>Format and validate terraform code before submission</li>
</ul>
<div class="fragment"><div class="line">terraform fmt .</div>
<div class="line">terraform validate .</div>
<div class="line"># Run a plan to see if the changes look fine</div>
<div class="line">terraform plan -compact-warnings</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md76"></a>
Troubleshooting</h2>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2
</small></address>
</body>
</html>
